#!/bin/sh

STRIKE_API_URL="https://api.strike.me/v1"
STRIKE_API_KEY="<your-strike-api-key>"

strike_check() {
    if [ "$#" -lt 2 ]; then
        echo "error: there are not enough parameters" >&2
        return 1
    fi
    invoice_id="$1"
    expected_amount="$2"

    response=$(curl -s -H "Authorization: Bearer $STRIKE_API_KEY" \
                     -H "Accept: application/json" \
                     "$STRIKE_API_URL/invoices/$invoice_id")
    
    invoice_amount=$(echo "$response" | jq -r '.amount.amount')
    currency=$(echo "$response" | jq -r '.amount.currency')
    state=$(echo "$response" | jq -r '.state')

    if [ "$state" != "PAID" ]; then
        echo "error: invoice is not paid. Current state: $state" >&2
        return 1
    fi

    if [ "$invoice_amount" != "$expected_amount" ]; then
        echo "error: invoice amount does not match. Expected: $expected_amount, Actual: $invoice_amount" >&2
        return 1
    fi

    echo "Invoice validated successfully."
    return 0
}

strike_pay() {
    if [ "$#" -lt 1 ]; then
        echo "error: there are not enough parameters" >&2
        return 1
    fi
    invoice="$1"

    # Generate payment quote
    response=$(curl -s -X POST "$STRIKE_API_URL/payment-quotes/lightning" \
                     -H "Authorization: Bearer $STRIKE_API_KEY" \
                     -H "Content-Type: application/json" \
                     -d "{\"lnInvoice\": \"$invoice\", \"sourceCurrency\": \"BTC\"}")

    payment_quote_id=$(echo "$response" | jq -r '.paymentQuoteId')
    if [ -z "$payment_quote_id" ]; then
        echo "error: failed to generate payment quote." >&2
        return 1
    fi

    # Execute payment
    execute_response=$(curl -s -X PATCH "$STRIKE_API_URL/payment-quotes/$payment_quote_id/execute" \
                              -H "Authorization: Bearer $STRIKE_API_KEY")

    if [ "$(echo "$execute_response" | jq -r '.state')" != "COMPLETED" ]; then
        echo "error: failed to execute payment." >&2
        return 1
    fi

    echo "Payment executed successfully."
    return 0
}

strike_invoice() {
    if [ "$#" -lt 3 ]; then
        echo "error: there are not enough parameters" >&2
        return 1
    fi
    amount="$1"
    currency="$2"
    description="$3"

    response=$(curl -s -X POST "$STRIKE_API_URL/invoices" \
                     -H "Authorization: Bearer $STRIKE_API_KEY" \
                     -H "Content-Type: application/json" \
                     -d "{\"amount\": {\"amount\": \"$amount\", \"currency\": \"$currency\"}, \"description\": \"$description\"}")

    invoice_id=$(echo "$response" | jq -r '.invoiceId')
    if [ -z "$invoice_id" ]; then
        echo "error: failed to create invoice." >&2
        return 1
    fi

    echo "Invoice created successfully. Invoice ID: $invoice_id"
    return 0
}

# Main script logic
action="$1"
shift 1

case "$action" in
    check)
        strike_check "$@"
    ;;
    pay)
        strike_pay "$@"
    ;;
    invoice)
        strike_invoice "$@"
    ;;
    *)
        echo "error: action $action not recognized" >&2
        exit 1
    ;;
esac
